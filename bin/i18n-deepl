#!/usr/bin/env node

import { program } from 'commander';
import { getSupportedLanguages, setAuthKey, translateJSON } from '../src/i18n-deepl.js';
import dotenv from 'dotenv';

dotenv.config();

program
  .command('languages')
  .description('List DeepLâ€™s supported languages.')
  .action(async () => {
    const options = program.opts();
    try {
      const languages = await getSupportedLanguages(options.authKey);
      console.log('Supported Languages:');
      languages.forEach(lang => console.log(`${lang.language} - ${lang.name}`));
    } catch (error) {
      console.error('Error fetching supported languages:', error);
    }
  });

program
  .command('set-auth authKey')
  .description('Sets the DeepL Auth key as environmental variable.')
  .action(async (authKey) => {
    await setAuthKey(authKey);
    return console.log('Success. DeepL Auth key is now set.');
  });

program
  .command('translate')
  .description('Translate texts from a JSON file to the target language.')
  .arguments('<source> <target> <targetLang>')
  .option('--auth-key <authKey>', 'The DeepL Auth Key.')
  .option('--source-lang <sourceLang>', 'Source language for translation, such as "de".')
  .option('--opts <options>', 'DeepL API options, given as object, i.E. --opts="{formality: \'less\'}."')
  .option('--source-sub <sourceSub>', 'Send only a sub-entry of the source JSON to DeepL API. ' +
    'I.E. --source-sub="translations.de]" will route to the nested entry \'translations\' and within it will send the entries of \'en\' to translation.')
  .option('--target-sub', 'Write the response from the translation API not to the root of the JSON file but to a sub-entry. ' +
    'I.E. --target-sub="[\'translations\', \'enUS\']" will insert the translation in {\'translations\': { \'enUS\': { ... }}.')
  .option('--dryRun, -dr', 'Perform a dry run and log it without making any changes to actual data.')
  .option('--log, -l', 'Log translation response to console.')
  .action(
    async (source, target, targetLang, options) => {

    console.log(options);

    try {
       await translateJSON(
        options.authKey || process.env.DEEPL_AUTH_KEY,
        source,
        target,
        targetLang,
         options.sourceLang || null,
         options.options || {}
      );
      console.log('success.')
    } catch (error) {
      console.error('Error translating texts:', error);
    }
  });

program.parse(process.argv);